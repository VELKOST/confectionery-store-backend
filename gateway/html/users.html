<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление пользователями</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
    async function loadUsers() {
        try {
            const users = await apiGet('/auth/users');  // Предполагаемый эндпоинт
            const userList = document.getElementById('userList');
            if (users.length === 0) {
                userList.innerHTML = '<tr><td colspan="5">Нет доступных пользователей.</td></tr>';
                return;
            }
            userList.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.role}</td>
                    <td><button onclick="changeRole(${u.id}, '${u.role}')">Изменить роль</button></td>
                </tr>
            `).join('');
        } catch (e) {
            alert('Ошибка загрузки пользователей: ' + e.message);
        }
    }

    async function changeRole(user_id, oldRole) {
        const role = prompt('Новая роль (user/admin/seller):', oldRole);
        if (role === null || role.trim() === '') {
            alert('Роль не может быть пустой.');
            return;
        }
        const validRoles = ['user', 'admin', 'seller'];
        if (!validRoles.includes(role.trim())) {
            alert('Неверная роль. Доступны: user, admin, seller.');
            return;
        }
        try {
            await apiPut(`/auth/users/${user_id}/role`, {role: role.trim()});
            alert('Роль пользователя успешно обновлена');
            loadUsers();
        } catch (error) {
            alert('Ошибка обновления роли пользователя: ' + error.message);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadUserInfo();
        const role = localStorage.getItem('user_role');
        if (!role || role !== 'admin') {
            alert('Только админ может управлять пользователями');
            window.location.href = '/';
            return;
        }
        loadUsers();
    });
    </script>
</head>
<body>
<h1>Управление пользователями</h1>
<div id="menu">
    <a href="/">Главная</a>
    <button onclick="logout()">Выйти</button>
</div>
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Email</th>
            <th>Роль</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody id="userList"></tbody>
</table>
</body>
</html>
